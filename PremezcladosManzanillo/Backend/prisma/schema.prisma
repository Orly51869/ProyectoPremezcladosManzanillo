datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}



// User model linked to Auth0 authentication
model User {
  id    String  @id // Corresponds to the 'sub' claim from the Auth0 JWT
  email String  @unique
  name  String?
  role  String? // User role from Auth0

  createdBudgets Budget[] @relation("CreatedBudgets")
  clients        Client[]
  processedBudgets Budget[] @relation("ProcessedBudgets") // Added directly to User model
  validatedPayments Payment[] @relation("ValidatedPayments") // Renamed for clarity
  notifications     Notification[] // Relation to notifications
}

// Client model associated with a User
model Client {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  rif         String?  // Nueva: Registro de Identificación Fiscal (RIF) o Cédula de Identidad
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to the User who owns this client record
  owner   User   @relation(fields: [ownerId], references: [id])
  ownerId String

  // Relation to Budgets
  budgets Budget[]
}

// Budget model
model Budget {
  id              String       @id @default(cuid())
  title           String
  address         String?      // Nueva: Dirección del proyecto
  deliveryDate    DateTime?    // Nueva: Fecha estimada de entrega/colado
  workType        String?      // Nueva: Tipo de obra (vivienda, edificio, etc.)
  resistance      String?      // Nueva: Resistencia requerida
  concreteType    String?      // Nueva: Tipo de concreto (convencional, bombeable, etc.)
  element         String?      // Nueva: Elemento a colar (losa, columna, etc.)
  observations    String?      // Nueva: Observaciones técnicas
  status          String @default("PENDING") // Revertido a String
  total           Float
  volume          Float?       // Reinsertado: Volumen total estimado del proyecto
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  creator   User   @relation("CreatedBudgets", fields: [creatorId], references: [id])
  creatorId String

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  products BudgetProduct[]
  payments Payment[] // Added reverse relation for payments from budget

  // Nuevos campos para el proceso de aprobación
  processedBy   User?   @relation("ProcessedBudgets", fields: [processedById], references: [id])
  processedById String?
  processedAt   DateTime?
  rejectionReason String?
}

// Payment model
model Payment {
  id                String    @id @default(cuid())
  budgetId          String
  budget            Budget    @relation(fields: [budgetId], references: [id])
  amount            Float
  paidAmount        Float     // Amount actually paid
  pending           Float     // Remaining amount owed
  date              DateTime  @default(now())
  method            String
  reference         String?
  bankFrom          String?
  bankTo            String?
  receiptUrl        String?   // URL to uploaded payment receipt
  status            String    @default("PENDING") // PENDING, VALIDATED, REJECTED
  observations      String?
  validatorId       String?
  validator         User?     @relation("ValidatedPayments", fields: [validatorId], references: [id])
  validatedAt       DateTime?

  invoice           Invoice? // Relation to the invoice

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Model for the products included in a budget (join table)
model BudgetProduct {
  id         String @id @default(cuid())
  quantity   Float
  unitPrice  Float // Price at the time of budget creation, for historical purposes
  totalPrice Float

  // Relation to Budget
  budget   Budget @relation(fields: [budgetId], references: [id])
  budgetId String

  // Relation to Product
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
}

// Model for Products and Services
model Product {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  price       Float
  // Type can be 'CONCRETE', 'BLOCK', 'SERVICE', etc.
  type        String
  // Category can be 'Estructurales', 'Pavimentos', 'Asesorias', etc.
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  budgets BudgetProduct[]
}

// Notification model for user alerts
model Notification {
  id        String   @id @default(cuid())
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relation to the User who receives the notification
  user   User   @relation(fields: [userId], references: [id])
  userId String
}

// Invoice model linked to a payment
model Invoice {
  id                  String   @id @default(cuid())
  invoiceNumber       String   @unique
  status              String   // PROFORMA, FISCAL_ISSUED
  proformaGeneratedAt DateTime @default(now())
  fiscalInvoiceUrl    String?
  deliveryOrderUrl    String?

  // One-to-one relation with Payment
  payment   Payment @relation(fields: [paymentId], references: [id])
  paymentId String  @unique
}

