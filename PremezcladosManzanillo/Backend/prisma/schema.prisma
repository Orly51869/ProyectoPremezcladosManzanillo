// ********************************
// *      schema.prisma           *
// ********************************
// Arquitectura de la base de datos


// Esquema de la base de datos
datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

// Modelo de usuario vinculado a la autenticación de Auth0
model User {
  id    String  @id // Corresponds to the 'sub' claim from the Auth0 JWT
  email String  @unique
  name  String?
  role  String? // User role from Auth0

  createdBudgets Budget[] @relation("CreatedBudgets")
  clients        Client[]
  processedBudgets Budget[] @relation("ProcessedBudgets") // Added directly to User model
  validatedPayments Payment[] @relation("ValidatedPayments") // Renamed for clarity
  notifications     Notification[] // Relation to notifications
}

// Modelo de cliente asociado con un Usuario
model Client {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  rif         String?  // Nueva: Registro de Identificación Fiscal (RIF) o Cédula de Identidad
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relación con el usuario que posee este registro de cliente
  owner   User   @relation(fields: [ownerId], references: [id])
  ownerId String

  // Relación con presupuestos
  budgets Budget[]
}

// Modelos de presupuestos
model Budget {
  id              String       @id @default(cuid())
  title           String
  address         String?      // Nueva: Dirección del proyecto
  deliveryDate    DateTime?    // Nueva: Fecha estimada de entrega/colado
  workType        String?      // Nueva: Tipo de obra (vivienda, edificio, etc.)
  resistance      String?      // Nueva: Resistencia requerida
  concreteType    String?      // Nueva: Tipo de concreto (convencional, bombeable, etc.)
  element         String?      // Nueva: Elemento a colar (losa, columna, etc.)
  observations    String?      // Nueva: Observaciones técnicas
  status          String @default("PENDING") // Revertido a String
  total           Float
  volume          Float?       // Reinsertado: Volumen total estimado del proyecto
  validUntil      DateTime?    // Nueva: Fecha de vencimiento del presupuesto
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  creator   User   @relation("CreatedBudgets", fields: [creatorId], references: [id])
  creatorId String

  client   Client @relation(fields: [clientId], references: [id])
  clientId String

  products BudgetProduct[]
  payments Payment[] // Relación con pagos

  // Nuevos campos para el proceso de aprobación
  processedBy   User?   @relation("ProcessedBudgets", fields: [processedById], references: [id])
  processedById String?
  processedAt   DateTime?
  rejectionReason String?
}

// Modelos de pagos
model Payment {
  id                String    @id @default(cuid())
  budgetId          String
  budget            Budget    @relation(fields: [budgetId], references: [id])
  amount            Float
  paidAmount        Float     // Amount actually paid
  pending           Float     // Remaining amount owed
  date              DateTime  @default(now())
  method            String
  reference         String?
  bankFrom          String?
  bankTo            String?
  receiptUrl        String?   // URL to uploaded payment receipt
  status            String    @default("PENDING") // PENDING, VALIDATED, REJECTED
  observations      String?
  
  currency          String    @default("USD")     // USD o VES
  exchangeRate      Float?                        // Tasa del BCV al momento del pago
  amountInCurrency  Float?                        // Monto en la moneda original (ej: Bs.)
  igtfAmount        Float?    @default(0)         // Monto del IGTF aplicado
  
  validatorId       String?
  validator         User?     @relation("ValidatedPayments", fields: [validatorId], references: [id])
  validatedAt       DateTime?

  invoice           Invoice? // Relation to the invoice

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Modelos de productos
model BudgetProduct {
  id         String @id @default(cuid())
  quantity   Float
  unitPrice  Float // Price at the time of budget creation, for historical purposes
  totalPrice Float

  // Relation to Budget
  budget   Budget @relation(fields: [budgetId], references: [id])
  budgetId String

  // Relation to Product
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
}

// Modelos de productos y servicios
model Product {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  price       Float
  // Tipo de producto (CONCRETE, BLOCK, SERVICE, etc.)
  type        String
  // Relaciones con categorías y subcategorías
  category    Category? @relation(fields: [categoryId], references: [id])
  categoryId  String?
  subcategory Subcategory? @relation(fields: [subcategoryId], references: [id])
  subcategoryId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  budgets BudgetProduct[]
  // Precios históricos por producto
  productPrices ProductPrice[]
}

// Categorías de productos
model Category {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  subcategories Subcategory[]
  products    Product[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Subcategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  category    Category  @relation(fields: [categoryId], references: [id])
  categoryId  String
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  @@unique([name, categoryId])
}

// Precios históricos por producto
model ProductPrice {
  id           String   @id @default(cuid())
  product      Product  @relation(fields: [productId], references: [id])
  productId    String
  date         DateTime // fecha cuando el precio es efectivo
  currency     String
  price        Float
  createdById  String?  // id del usuario que estableció el precio
  createdByRole String?
  createdAt    DateTime @default(now())

  @@index([productId, date])
}

// Modelo de notificación para alertas de usuario
model Notification {
  id        String   @id @default(cuid())
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relación con el usuario que recibe la notificación
  user   User   @relation(fields: [userId], references: [id])
  userId String
}

// Modelo de factura vinculada a un pago
model Invoice {
  id                  String   @id @default(cuid())
  invoiceNumber       String   @unique
  status              String   // PROFORMA, FISCAL_ISSUED
  proformaGeneratedAt DateTime @default(now())
  fiscalInvoiceUrl    String?
  deliveryOrderUrl    String?

  // Relación uno a uno con Payment
  payment   Payment @relation(fields: [paymentId], references: [id])
  paymentId String  @unique
}

// Modelo para rastrear actividades y cambios administrativos de usuarios
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  userName  String?
  action    String   // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN", "ROLE_CHANGE"
  entity    String   // e.g., "BUDGET", "CLIENT", "PAYMENT", "USER_ROLE"
  entityId  String?
  details   String?  // JSON string with more info
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// Modelo para configuraciones dinámicas de la aplicación (fondos, títulos, etc.)
model Setting {
  key       String   @id
  value     String
  type      String   @default("text") // text, image, color, etc.
  updatedAt DateTime @updatedAt
}

// Modelo para la galería de proyectos/obras finalizadas (Portfolio)
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String?
  location    String?
  date        String?   // Cambiado a String para soportar "2024", "En curso", etc.
  category    String? // e.g., "Industrial", "Residencial", "Vialidad"
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
